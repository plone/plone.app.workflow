<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="context/@@standard_macros/page"
      i18n:domain="plone">

<head>

<body>

<div metal:fill-slot="body">

<div metal:use-macro="context/document_actions/macros/document_actions">
    Document actions (print, sendto etc)
</div>

<h1 i18n:translate="heading_portal_setup">Type Settings</h1>

<a href=""
    class="link-parent"
    tal:attributes="href string: $portal_url/plone_control_panel"
    i18n:translate="label_up_to_plone_setup">
        Up to Site Setup
</a>

<p class="documentDescription"
    i18n:translate="description_plone_setup">
         Workflow, visibility and versioning settings for your content types.
</p>

<script type="text/javascript">
function redirect() {
    options = document.getElementById("types").childNodes
    for(var i=0; i < options.length; i++) {
        if(options[i].selected) val=options[i].value
    }
    self.location='prefs_types?type_id=' + val
}
</script>

<script type="text/javascript">
function redirect_new_workflow() {
    options_types = document.getElementById("types").childNodes
    options_workflows = document.getElementById("workflows")
    for(var i=0; i < options_types.length; i++) {
        if(options_types[i].selected) val_types=options_types[i].value
    }
    for(var i=0; i < options_workflows.length; i++) {
        if(options_workflows[i].selected) val_workflows=options_workflows[i].value
    }
    self.location='prefs_types?type_id=' + val_types + '&wf_id=' + val_workflows 
}
</script>

<form method="POST" 
      tal:attributes="action string:${context/absolute_url}/@@prefs_types">
    <input type="hidden" name="form.submitted:boolean" value="True" />

    <fieldset tal:define="type_id python:request.get('type_id', 'Document');
                            type_obj python:portal.portal_types[type_id]">

        <legend >

          <select onchange="javascript:redirect()" id="types" name="type_id">
            <tal:types repeat="type python:[portal.portal_types.getTypeInfo(t) for t in here.getPortalTypes()]">
              <option
                tal:content="type/Title"
                tal:attributes="value type/id;
                                selected python: view.is_type_selected(type, type_id)">Page (aka. Document)
              </option>

            </tal:types>
            </select>
        </legend>


        <label>Title</label>
        <input type="text" value="Page"
            tal:attributes="value type_obj/Title"/>
        
        <div style="margin: 1em 0">
            <input type="checkbox"
                   name="addable"
                   checked="checked"
                   tal:attributes="checked python:view.is_type_globally_allowed(type)">
            <label>Addable</label>

            <input type="checkbox"
                     name="allow_discussion"
                     checked="checked"
                     tal:attributes="checked python:view.is_type_discussion_allowed(type)">
            <label>Allow comments</label>

            <input type="checkbox"
                   name="enable_versioning"
                   tal:attributes="checked python:view.is_type_versionable(type_id)">
            <label>Enable versioning</label>

            <input type="checkbox"
                   name="visibility"
                   checked="checked"
                   tal:attributes="checked python:view.is_type_searchable(type_id)">
            <label>Visible in searches</label>

        </div>

        <div style="float: left">
            <label>Current workflow</label><br />
            <span tal:content="python: view.current_workflow(type_id)">Community Workflow</span>
        </div>

        <div style="float: left; margin-left:3em">
            <label>New workflow</label><br />
            <select onchange="javascript:redirect_new_workflow()" id="workflows" name="wf_id">
                <option value="No Change">No Change</option>

                <tal:wfs repeat="wf python:portal.portal_workflow.objectValues()"
                    tal:define="wf_id python:request.get('wf_id', 'No Change')">
                    <option tal:content="python: view.wf_title_for_id(wf.id)"
                            tal:attributes="selected python: view.is_wf_selected(wf, wf_id);
                                            value python: wf.id">Intranet Workflow
                    </option>
                </tal:wfs>

                <option>No Workflow</option>
            </select>
        </div>

        <tal:check_wf_in_request tal:condition="exists: request/wf_id" >
          <tal:check_wf_in_request_change_selected tal:condition="python: request.wf_id != 'No Change'">

            <!-- This only shows up if you actually selected a change in the workflow -->

            <div class="visualClear" tal:define="wf_id python:request.get('wf_id', 'No Change')">
                <label>State Mapping</label>

                <div class="formHelp">
                    When changing workflows, you have to select a state equivalent in the new workflow.
                </div>

                <table class="listing" 
                    tal:define="states python:view.states_for_new_workflow(wf_id);
                                old_states python:view.states_for_current_workflow(type_id);">
                    <thead>
                        <tr>
                            <th>Old State</th>
                            <th>New State</th>
                        </tr>
                    </thead>

                    <tbody tal:repeat="old_state old_states">

                        <tr tal:attributes="class python:oddrow and 'odd' or 'even'"
                            tal:define="oddrow repeat/old_state/odd;">

                            <td tal:content="old_state"> Published </td>
                            <td tal:attributes="class python:oddrow and 'odd' or 'even'">
                                <select>
                                  <tal:states repeat="state states">              
                                    <option tal:content="state">Pending</option>
                                  </tal:states>
                                </select>
                            </td>
                        </tr>
                    </tbody>

                </table>

            </div>

          </tal:check_wf_in_request_change_selected>
        </tal:check_wf_in_request>

        <div class="visualClear" style="float:left;margin-top:1em" class="formControls">
          <input type="submit" value="Cancel" name="form.button.Cancel" class="standalone" />
          <input type="submit" value="Apply" name="form.button.Apply" class="context" />
            
            <!-- This only shows up if changes were made to the workflow settings, since the remapping
                 could be expensive --> 
            <tal:check_wf_in_request tal:condition="exists: request/wf_id" >
              <tal:check_wf_in_request_change_selected tal:condition="python: request.wf_id != 'No Change'">
                <img tal:replace="structure here/info_icon.gif" />
                <span style="color: red">This may take a long time, and may slow down Plone significantly.</span>
              </tal:check_wf_in_request_change_selected>
            </tal:check_wf_in_request>
        </div>

    </fieldset>


</form>

</div>

</body>
</html>
